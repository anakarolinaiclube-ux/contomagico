<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F√°brica de Sonhos - Hist√≥rias Ilustradas</title>
    <!-- Fontes L√∫dicas -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <!-- Biblioteca PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-color: #f0f0f0;
            --card-bg: rgba(255, 255, 255, 0.95);
            --primary: #FF6B6B;
            --text: #2d3436;
        }

        /* --- THEMES (Cen√°rios) --- */
        body.theme-padrao { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); }
        
        body.theme-floresta { 
            background: linear-gradient(to bottom, #A8E6CF, #DCEDC1); 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 30h2v20h-2z' fill='%23558b2f' fill-opacity='0.1'/%3E%3Ccircle cx='31' cy='25' r='8' fill='%23558b2f' fill-opacity='0.1'/%3E%3C/svg%3E");
        }

        body.theme-espaco { 
            background: radial-gradient(circle at center, #2b1055, #7597de);
            color: #fff; /* Texto fora do card fica branco */
            /* Estrelinhas simples via CSS */
            background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0, 25px 25px;
        }

        body.theme-mar { 
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
            background-image: radial-gradient(circle, rgba(255,255,255,0.2) 10%, transparent 10%);
            background-size: 30px 30px; 
        }

        body.theme-reino { 
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            background-image: radial-gradient(#fff 15%, transparent 16%);
            background-size: 20px 20px;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: background 0.5s ease;
        }

        .container {
            background-color: var(--card-bg);
            color: #333; /* For√ßa cor escura dentro do card */
            width: 100%;
            max-width: 700px;
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            margin-top: 20px;
            border: 4px solid #fff;
            position: relative;
            overflow: hidden;
        }

        h1 {
            font-family: 'Comic Neue', cursive;
            text-align: center;
            color: var(--primary);
            font-size: 2.8rem;
            margin-bottom: 10px;
        }

        /* Form Styling */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-primary {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            transition: transform 0.2s;
        }
        .btn-primary:hover { transform: scale(1.02); background: #ff5252; }

        /* Story Reader Styles */
        #story-container {
            font-family: 'Comic Neue', cursive;
            font-size: 1.35rem;
            line-height: 1.8;
            color: #2c3e50;
        }

        #story-container h2 {
            text-align: center;
            color: var(--primary);
            font-size: 2.2rem;
            margin-top: 0;
        }

        /* Image generated styling */
        .story-image-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .story-image-container img {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 5px solid #fff;
            transform: rotate(-2deg); /* Efeito l√∫dico */
        }

        .hidden { display: none; }

        /* Spinner */
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .loading-text { text-align: center; font-size: 1.2rem; color: #666; }
        
        /* Action Buttons */
        .actions { margin-top: 30px; display: flex; gap: 10px; justify-content: center; }
        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            font-family: inherit;
        }
        .btn-pdf { background-color: #2ecc71; color: white; }
        .btn-new { background-color: #95a5a6; color: white; }

    </style>
</head>
<body class="theme-padrao">

<div class="container" id="main-card">
    
    <!-- TELA 1: Formul√°rio -->
    <div id="form-screen">
        <h1>F√°brica de Sonhos ‚ú®</h1>
        <p style="text-align: center; color: #777; margin-bottom: 30px;">
            Preencha os detalhes para criar um livro m√°gico instant√¢neo!
        </p>

        <form id="story-form">
            <div class="form-group">
                <label>Nome do Her√≥i/Hero√≠na</label>
                <input type="text" id="nome" placeholder="Ex: Valentina" required>
            </div>

            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label>Idade</label>
                    <input type="number" id="idade" placeholder="Ex: 6" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Cen√°rio (Muda o visual!)</label>
                    <select id="cenario" onchange="changeTheme(this.value)">
                        <option value="padrao">Padr√£o</option>
                        <option value="floresta">Floresta Encantada üåø</option>
                        <option value="espaco">Espa√ßo Sideral üöÄ</option>
                        <option value="mar">Fundo do Mar üê†</option>
                        <option value="reino">Reino M√°gico üè∞</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Caracter√≠sticas (Cabelo, olhos, roupas...)</label>
                <input type="text" id="caracteristicas" placeholder="Ex: Cabelo cacheado e capa vermelha">
            </div>

            <div class="form-group">
                <label>O que vai acontecer? (G√™nero)</label>
                <select id="genero">
                    <option value="Aventura">Uma grande aventura</option>
                    <option value="Mist√©rio">Um mist√©rio para resolver</option>
                    <option value="Amizade">Hist√≥ria sobre amizade</option>
                    <option value="Super-Her√≥i">Tornar-se Super-Her√≥i</option>
                </select>
            </div>

            <div class="form-group">
                <label>Li√ß√£o Final</label>
                <input type="text" id="mensagem" placeholder="Ex: Acreditar em si mesmo">
            </div>

            <button type="submit" class="btn-primary">Criar Hist√≥ria Ilustrada üé®</button>
        </form>
    </div>

    <!-- TELA 2: Loading -->
    <div id="loading-screen" class="hidden">
        <div class="spinner"></div>
        <p class="loading-text">A Intelig√™ncia Artificial est√° escrevendo e desenhando...<br>Isso pode levar alguns segundos!</p>
    </div>

    <!-- TELA 3: Resultado -->
    <div id="result-screen" class="hidden">
        <div id="story-content">
            <!-- Conte√∫do Injetado Aqui -->
        </div>

        <div class="actions">
            <button onclick="downloadPDF()" class="btn-action btn-pdf">Baixar Livro PDF üì•</button>
            <button onclick="location.reload()" class="btn-action btn-new">Criar Nova üîÑ</button>
        </div>
    </div>

</div>

<script>
    // L√≥gica para mudar o background dinamicamente antes de enviar
    function changeTheme(theme) {
        document.body.className = `theme-${theme}`;
    }

    const form = document.getElementById('story-form');
    const loadingScreen = document.getElementById('loading-screen');
    const formScreen = document.getElementById('form-screen');
    const resultScreen = document.getElementById('result-screen');
    const storyContent = document.getElementById('story-content');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // UI Updates
        formScreen.classList.add('hidden');
        loadingScreen.classList.remove('hidden');
        
        // Coletar dados
        const cenarioSelect = document.getElementById('cenario');
        const cenarioText = cenarioSelect.options[cenarioSelect.selectedIndex].text;

        const data = {
            nome: document.getElementById('nome').value,
            idade: document.getElementById('idade').value,
            caracteristicas: document.getElementById('caracteristicas').value,
            cenario: cenarioText, // Envia o texto bonito para a IA
            genero: document.getElementById('genero').value,
            mensagem: document.getElementById('mensagem').value
        };

        try {
            const response = await fetch('/api/ai', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const json = await response.json();

            if (response.ok) {
                storyContent.innerHTML = json.result;
                loadingScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');
            } else {
                throw new Error(json.error);
            }
        } catch (error) {
            alert('Ops! Demorou muito ou houve um erro: ' + error.message);
            loadingScreen.classList.add('hidden');
            formScreen.classList.remove('hidden');
        }
    });

    function downloadPDF() {
        // Seleciona o card inteiro para manter o estilo na impress√£o
        const element = document.getElementById('story-content');
        
        // Configura√ß√µes para garantir que a imagem saia no PDF
        const opt = {
            margin:       0.5,
            filename:     `historia-magica.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true }, // useCORS √© vital para imagens externas
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        html2pdf().set(opt).from(element).save();
    }
</script>

</body>
</html>
