<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mundo das Hist√≥rias</title>
    <!-- Fontes Premium para Leitura e T√≠tulos -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --card-bg: rgba(255, 255, 255, 0.96);
            --text-color: #2c3e50;
            --primary-accent: #6C5CE7;
            --shadow-elevation: 0 20px 60px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center; /* Centraliza verticalmente */
            overflow-x: hidden;
            background-color: #f0f0f0;
            transition: background 1.5s ease;
            position: relative;
        }

        /* --- SISTEMA DE ATMOSFERA (THEMES) --- */
        
        /* Elementos globais de atmosfera */
        body::before, body::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            transition: opacity 1.5s ease;
            z-index: 0;
        }

        /* 1. PADR√ÉO: Sonho nas Nuvens */
        body.theme-padrao {
            background: linear-gradient(180deg, #89f7fe 0%, #66a6ff 100%);
        }
        body.theme-padrao::before {
            background: radial-gradient(circle at 80% 20%, rgba(255,255,255,0.4) 0%, transparent 20%),
                        radial-gradient(circle at 20% 80%, rgba(255,255,255,0.3) 0%, transparent 30%);
            filter: blur(40px);
        }
        body.theme-padrao::after {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 50 Q35 30 50 50 T80 50' fill='none' stroke='white' stroke-width='2' stroke-opacity='0.5'/%3E%3C/svg%3E");
            opacity: 0.3;
            animation: floatClouds 60s infinite linear;
        }

        /* 2. FLORESTA: Luz entre as folhas */
        body.theme-floresta {
            background: linear-gradient(to bottom, #134E5E, #71B280); /* Verde profundo */
        }
        body.theme-floresta::before {
            /* Raios de sol filtrados */
            background: radial-gradient(circle at 50% 0%, rgba(255, 255, 200, 0.3) 0%, transparent 60%);
            animation: sunPulse 10s infinite alternate;
        }
        body.theme-floresta::after {
            /* Part√≠culas flutuantes (vagalumes/p√≥len) */
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.4;
            animation: particleRise 20s infinite linear;
        }

        /* 3. ESPA√áO: Profundidade C√≥smica */
        body.theme-espaco {
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
        }
        body.theme-espaco::before {
            /* Nebulosa */
            background: 
                radial-gradient(circle at 20% 30%, rgba(76, 29, 149, 0.4), transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 128, 0.2), transparent 50%);
            filter: blur(30px);
        }
        body.theme-espaco::after {
            /* Estrelas */
            background-image: radial-gradient(white 1px, transparent 1px), radial-gradient(white 1.5px, transparent 1.5px);
            background-size: 60px 60px, 130px 130px;
            background-position: 0 0, 30px 30px;
            animation: starsTwinkle 120s infinite linear;
        }

        /* 4. MAR: Submers√£o Calma */
        body.theme-mar {
            background: linear-gradient(180deg, #4facfe 0%, #00f2fe 100%);
        }
        body.theme-mar::before {
            /* Efeito de luz na √°gua (Caustics simulado) */
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, transparent 20px, rgba(255,255,255,0.05) 40px);
            animation: waterRefract 15s infinite ease-in-out alternate;
        }
        body.theme-mar::after {
            /* Profundidade azul escura */
            background: linear-gradient(to top, rgba(0,20,60,0.6) 0%, transparent 100%);
        }

        /* 5. REINO: P√¥r do sol m√°gico */
        body.theme-reino {
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 50%, #E0C3FC 100%);
        }
        body.theme-reino::before {
            /* Brilho dourado central */
            background: radial-gradient(circle at center, rgba(255,215,0,0.2) 0%, transparent 70%);
            animation: royalGlow 5s infinite alternate;
        }
        body.theme-reino::after {
            /* Textura sutil de brilho */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 0 L22 18 L40 20 L22 22 L20 40 L18 22 L0 20 L18 18 Z' fill='white' fill-opacity='0.2'/%3E%3C/svg%3E");
            background-size: 80px 80px;
            opacity: 0.5;
            animation: particleRise 40s infinite linear;
        }

        /* --- ANIMA√á√ïES SUTIS --- */
        @keyframes sunPulse { 0% { opacity: 0.5; } 100% { opacity: 0.8; } }
        @keyframes particleRise { 0% { background-position: 0% 100%; } 100% { background-position: 0% 0%; } }
        @keyframes starsTwinkle { 0% { transform: rotate(0deg); } 100% { transform: rotate(5deg); } }
        @keyframes waterRefract { 0% { opacity: 0.3; transform: scale(1); } 100% { opacity: 0.6; transform: scale(1.05); } }
        @keyframes royalGlow { 0% { transform: scale(0.9); } 100% { transform: scale(1.1); } }
        @keyframes floatClouds { from { background-position: 0 0; } to { background-position: 100% 0; } }

        /* --- CONTAINER PRINCIPAL (O LIVRO) --- */
        .container {
            position: relative;
            z-index: 10;
            background-color: var(--card-bg);
            width: 90%;
            max-width: 650px;
            padding: 50px;
            border-radius: 24px;
            box-shadow: var(--shadow-elevation);
            margin: 40px 0;
            border: 1px solid rgba(255,255,255,0.6);
            backdrop-filter: blur(5px); /* Efeito vidro sutil */
        }

        /* --- TIPOGRAFIA E ELEMENTOS --- */
        h1 {
            font-family: 'Pacifico', cursive;
            color: var(--primary-accent);
            text-align: center;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        .intro { text-align: center; color: #636e72; margin-bottom: 40px; font-size: 1.1rem; }

        .form-group { margin-bottom: 25px; }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #4a69bd;
            font-size: 0.95rem;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border: 2px solid #dfe6e9;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            background: #fdfdfd;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
            outline: none;
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #6C5CE7, #a29bfe);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 92, 231, 0.4);
        }

        /* --- ESTILO DA HIST√ìRIA GERADA --- */
        #story-content {
            line-height: 1.9;
            font-size: 1.2rem;
            color: #2d3436;
        }
        
        #story-content h2 {
            font-family: 'Pacifico', cursive;
            color: var(--primary-accent);
            text-align: center;
            font-size: 2.2rem;
            margin-top: 0;
            margin-bottom: 30px;
        }

        #story-content p { margin-bottom: 20px; }
        
        /* Destaque para a mensagem final */
        #story-content p:last-child {
            background-color: rgba(108, 92, 231, 0.1);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid var(--primary-accent);
            font-style: italic;
            margin-top: 30px;
            text-align: center;
        }

        .actions { display: flex; gap: 15px; margin-top: 40px; }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-accent);
            color: var(--primary-accent);
            box-shadow: none;
        }
        .btn-outline:hover { background: var(--primary-accent); color: white; }

        .hidden { display: none; }
        
        /* Spinner Personalizado */
        .spinner {
            width: 60px; height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--primary-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .container { padding: 30px; width: 90%; }
            h1 { font-size: 2.2rem; }
        }
    </style>
</head>
<body class="theme-padrao">

    <div class="container">
        
        <!-- TELA 1: FORMUL√ÅRIO -->
        <div id="form-screen">
            <h1>Criar Hist√≥ria M√°gica ‚ú®</h1>
            <p class="intro">Personalize uma aventura inesquec√≠vel para ler agora mesmo.</p>

            <form id="story-form">
                <div class="form-group">
                    <label>Nome da Crian√ßa</label>
                    <input type="text" id="nome" placeholder="Ex: Bia" required>
                </div>

                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1;">
                        <label>Idade</label>
                        <input type="number" id="idade" placeholder="Anos" required>
                    </div>
                    <div style="flex: 1;">
                        <label>G√™nero</label>
                        <select id="genero">
                            <option value="Aventura">Aventura</option>
                            <option value="Fantasia">Fantasia</option>
                            <option value="Fic√ß√£o">Espa√ßo</option>
                            <option value="Super-Her√≥i">Her√≥i</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cen√°rio (Define o Visual)</label>
                    <select id="cenario" onchange="changeTheme(this.value)">
                        <option value="padrao">Sonho nas Nuvens ‚òÅÔ∏è</option>
                        <option value="floresta">Floresta Encantada üåø</option>
                        <option value="espaco">Viagem ao Espa√ßo üöÄ</option>
                        <option value="mar">Fundo do Mar üê†</option>
                        <option value="reino">Reino M√°gico üè∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Mensagem / Li√ß√£o (Ex: Coragem)</label>
                    <input type="text" id="mensagem" placeholder="Ex: Compartilhar brinquedos">
                </div>

                <button type="submit">Gerar Hist√≥ria</button>
            </form>
        </div>

        <!-- TELA 2: LOADING -->
        <div id="loading-screen" class="hidden" style="text-align: center; padding: 40px 0;">
            <div class="spinner"></div>
            <h3 style="color: var(--primary-accent); margin-top: 20px;">Escrevendo...</h3>
            <p style="color: #666;">A magia est√° acontecendo, aguarde um pouquinho!</p>
        </div>

        <!-- TELA 3: HIST√ìRIA -->
        <div id="result-screen" class="hidden">
            <div id="story-content"></div>

            <div class="actions">
                <button onclick="downloadPDF()" style="flex: 1;">Baixar PDF üì•</button>
                <button onclick="location.reload()" class="btn-outline" style="flex: 1;">Nova Hist√≥ria üîÑ</button>
            </div>
        </div>

    </div>

    <script>
        function changeTheme(theme) {
            document.body.className = `theme-${theme}`;
        }

        const form = document.getElementById('story-form');
        const formScreen = document.getElementById('form-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultScreen = document.getElementById('result-screen');
        const storyContent = document.getElementById('story-content');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const cenarioSelect = document.getElementById('cenario');
            const data = {
                nome: document.getElementById('nome').value,
                idade: document.getElementById('idade').value,
                genero: document.getElementById('genero').value,
                // Passa o texto leg√≠vel para a IA
                cenario: cenarioSelect.options[cenarioSelect.selectedIndex].text,
                mensagem: document.getElementById('mensagem').value
            };

            formScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');

            try {
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const json = await response.json();

                if (response.ok) {
                    storyContent.innerHTML = json.result;
                    loadingScreen.classList.add('hidden');
                    resultScreen.classList.remove('hidden');
                } else {
                    alert('Erro: ' + json.error);
                    location.reload();
                }
            } catch (error) {
                alert('Erro de conex√£o. Tente novamente.');
                location.reload();
            }
        });

        function downloadPDF() {
            const element = document.getElementById('story-content');
            const opt = {
                margin: 1,
                filename: 'historia-magica.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
